#!/bin/bash
while test $# -gt 0; do
  case "$1" in
    -h|--help)
      echo "$package - attempt to capture frames"
      echo " "
      echo "$package [options] application [arguments]"
      echo " "
      echo "options:"
      echo "-I, Installs package"
      echo "-S, Search for package"
      echo "-R, Removes package"
      echo "-C, Chooses repo"
      echo "-U, Update script"
      echo "-V, Prints version number"
      echo "-L, Lists installed packages"
      echo "-D, Downloads but doesn't install"
      exit 0
      ;;
    -I) 
      curl https://raw.githubusercontent.com/Henryws/pacstall/master/website-images/pacstallascii.txt
      package=$2
      repo=$(cat /usr/share/pacstall/repo/pacstallrepo.txt)
      RED='\033[0;31m'
      CYAN='\033[0;36m'
      NC='\033[0m' # No Color
      GREEN='\033[0;32m'
      PURPLE='\033[0;35m'
      YELLOW='\033[1;33m'
      BLUE='\033[0;34m'
      if [ ! -d /tmp/pacstall ]; then
	  mkdir -p /tmp/pacstall;
      fi
      #This is the part where it searches your package on all repos and puts it in /tmp
      echo -e "cleaning ${YELLOW}/tmp/pacstall${NC}"
      sudo rm -rf /tmp/pacstall
      sudo mkdir /tmp/pacstall
      cd /tmp/pacstall/
      echo "cleaning package build directory"
      sudo rm -rf $package
      # This is where pacstall will alert the user of anything they might need to know that could affect the installation of there package
      echo "File exists, proceeding to install."
      wget -O- https://raw.githubusercontent.com/$repo/pacstall/master/packages/$package/alerts.sh | bash
      wget -O- https://raw.githubusercontent.com/$repo/pacstall/master/packages/$package/depends.sh | bash
      if wget -q --show-progress --progress=bar:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$package/$package.tar.xz ; then
          echo "tar.xz detected"
          echo -e "${RED}extracting...${NC}"
          sudo tar -xf $package.tar.xz
      else
          echo "tar.xz not detected... trying zip"
          wget -q --show-progress --progress=bar:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$package/$package.zip
          echo -e "${RED}extracting...${NC}"
          sudo unzip /tmp/pacstall/$package.zip
      fi
      cd $package
      echo -e "${CYAN}Downloading and running install script for ${GREEN}$package...${NC}"
      wget -O- https://raw.githubusercontent.com/$repo/pacstall/master/packages/$package/install.sh | bash
      echo -e "${GREEN}Cleaning up...${NC}"
      cd /tmp/pacstall
      rm -rf $package*
      echo "Indexing..."
      echo $package >> /etc/pacstall_packages
      sudo sed -i '$!N; /^\(.*\)\n\1$/!P; D' /etc/pacstall_packages
      echo -e "${CYAN}Done${NC}"     
      if [ $? -eq 0 ]
      then
        echo -e "${GREEN}Successfully installed ${NC}$package"
	exit 0
      else
        echo -e "${RED}Could not install ${NC}$package"
	exit 1
      fi
      ;;
    -S)
     search=$2
     repo=$(cat /usr/share/pacstall/repo/pacstallrepo.txt)
     wget -q --spider https://github.com/$repo/pacstall/tree/master/packages/$search/
     if [ $? -eq 0 ]; then
        read -p "${GREEN}"$search"${NC} is available in the ${PURPLE}"$repo"${NC} repository. Do you want to see the readme?" answer
	if [[ $answer = y ]] ; then
	pandoc -t plain https://raw.githubusercontent.com/$repo/pacstall/master/packages/$search/README.md | less
        fi
     else
        echo $search is not available. Add another repo or check your spelling
     fi
      ;;
    -R)
      package=$2
      sudo dpkg -r $package
      if [ $? -eq 0 ]; then
          echo "$package has been succesfuly removed"
      else
          echo "$package could not be removed"
      fi
      ;;
    -C)
      echo "repo changer"
      cmd=(dialog --separate-output --checklist "Select Repository:" 22 76 16)
      options=(1 "Henryws" on    # any option can be set to default to "on"
               2 "Option 2" off
               3 "Option 3" off
               4 "Option 4" off)
      choices=$("${cmd[@]}" "${options[@]}" 2>&1 >/dev/tty)
      clear
      for choice in $choices
      do
          case $choice in
              1)
                  echo -e "${PURPLE}Henryws${NC} repository selected" && echo Henryws > /usr/share/pacstall/repo/pacstallrepo.txt
                  exit
                  ;;
              2)
                  echo "Second Option"
                  ;;
              3)
                  echo "Third Option"
                  ;;
              4)
                  echo "Fourth Option"
                  ;;
          esac
      done
      ;;
    -V)
      YELLOW='\033[1;33m'
      NC='\033[0m' # No Color
      echo -e "version 1.0.1 ${YELLOW}Aureolin${NC}"
      break
      ;;
    -U)
      sudo wget -q https://raw.githubusercontent.com/Henryws/pacstall/master/pacstall -O /bin/pacstall
      echo "Updating complete"
      exit 0
      ;;
    -L)
      wc -l /etc/pacstall_packages
      cat /etc/pacstall_packages
      exit 0
      ;;
     -D)
       package=$2
       repo=$(cat /usr/share/pacstall/repo/pacstallrepo.txt)
       #Downloads but doesn't install
       if [ ! -d /var/cache/pacstall ]; then
	  mkdir -p /var/cache/pacstall;
       fi
       cd /usr/share/pacstall/cache
       if wget -q -P /var/cache/pacstall --show-progress --progress=bar:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$package/$package.tar.xz; then
          echo "tar.xz detected"
       else
          echo "tar.xz not detected... trying zip"
          wget -q -P /var/cache/pacstall --show-progress --progress=bar:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$package/$package.zip
       fi
       echo -e "Saved $package to ${YELLOW}/var/cache/pacstall/${NC}"
       ;;
     *)
      break
      ;;
  esac
done 
