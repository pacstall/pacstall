#!/bin/bash
while test $# -gt 0; do
  case "$1" in
    -h|--help)
      echo " "
      echo "options:"
      echo "-I --install, Installs package"
      echo "-S --search, Search for package"
      echo "-R --remove, Removes package"
      echo "-C --change-repo, Chooses repo"
      echo "-U --update, Update script"
      echo "-V --version, Prints version number"
      echo "-L --list, Lists installed packages"
      echo "-DL --download-local, Downloads to local package"
      echo "-IL --install-local, Installs local package"
      echo " "
      exit 0
      ;;
    -I|--install) 
      function trap_ctrlc ()
      {
          echo "Ctrl-C caught...performing clean up"
          rm -rf /tmp/pacstall/*
	  echo "the installation of $2 was interrupted, removing files"
          exit 2
      }
      trap "trap_ctrlc" 2
      if [ "$EUID" -ne 0 ]
      then echo "Please run as root"
      exit 1
      fi
      support=grep -E "Ubuntu|Fedora" /etc/lsb_release
      if [[ $support -eq 1 ]] ; then
      	  RED='\033[0;31m'
	  NC='\033[0m'
	  echo -e "${RED}Unsupported Distrobution${NC}"
	  exit 1
      fi
      grep -c -q "ascii_art: true" /usr/share/pacstall/config.conf || curl https://raw.githubusercontent.com/Henryws/pacstall/master/website-images/pacstallascii.txt
      if [[ $? -eq 1 ]] ; then
      curl https://raw.githubusercontent.com/Henryws/pacstall/master/website-images/pacstallascii.txt
      fi
      package=$2
      if [[ ! -e /usr/share/pacstall/repo/ ]]; then
          mkdir -p /usr/share/pacstall/repo
          touch /usr/share/pacstall/repo/pacstallrepo.txt
	  sudo pacstall -C
      fi
      repo=$(cat /usr/share/pacstall/repo/pacstallrepo.txt)
      RED='\033[0;31m'
      CYAN='\033[0;36m'
      NC='\033[0m' # No Color
      GREEN='\033[0;32m'
      PURPLE='\033[0;35m'
      YELLOW='\033[1;33m'
      BLUE='\033[0;34m'
      if [ ! -d /tmp/pacstall ]; then
	  mkdir -p /tmp/pacstall;
      fi
      #This is the part where it searches your package on all repos and puts it in /tmp
      echo -e "Preparing ${YELLOW}/tmp/pacstall${NC}"
      sudo rm -rf /tmp/pacstall
      sudo mkdir /tmp/pacstall
      cd /tmp/pacstall/ || exit
      echo "cleaning $package build directory"
      sudo rm -rf "$package"
      # This is where pacstall will alert the user of anything they might need to know that could affect the installation of there package
      url=https://raw.githubusercontent.com/$repo/pacstall/master/packages/$package/install.sh
      if wget -q "$url" >/dev/null 2>&1 ; then

          #Finds package size and prompts for installation
          wget -qO- https://raw.githubusercontent.com/$repo/pacstall/master/packages/$package/alerts.sh | bash
          alertserror=$?
	  if wget -q --spider https://github.com/$repo/pacstall/raw/master/packages/$package/$package.tar.xz ; then
          pkgsize=$(curl -s https://github.com/$repo/pacstall/raw/master/packages/$package/$package.tar.xz | wc -c)
	      echo "$package will take up $pkgsize" && echo " "
          else    
          pkgsize=$(curl -s https://github.com/$repo/pacstall/raw/master/packages/$package/$package.zip | wc -c)
	      echo "$package will take up $pkgsize" && echo " "
	  fi	  
	  printf 'Proceed to install? [y/n] : '
      read -r yesorno
      if [[ "$yesorno" =~ ^([n/N])$ ]] ; then
        exit 0
      fi
      if wget -q --show-progress --progress=bar:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$package/$package.tar.xz ; then
          echo "file found"
          echo -e "${RED}extracting...${NC}"
          sudo tar -xf "$package".tar.xz
      else
          echo "file found"
          wget -q --show-progress --progress=bar:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$package/$package.zip
          echo -e "${RED}extracting...${NC}"
          sudo unzip /tmp/pacstall/$package.zip
      fi
      cd $package || exit
      wget -O- https://raw.githubusercontent.com/$repo/pacstall/master/packages/$package/depends.sh | bash
      
      dependserror=$?
      echo -e "${CYAN}Downloading and running install script for ${GREEN}$package...${NC}"
	  
      wget -O- https://raw.githubusercontent.com/$repo/pacstall/master/packages/$package/install.sh | bash
      installerror=$?
       
      echo -e "${GREEN}Cleaning up${NC}"
      cd /tmp/pacstall || exit
      rm -rf "$package"*
      echo " "
      echo "Checking for any errors"
      if [[ $alertserror = 0 ]]
      then
        echo -e "${GREEN}No errors in alerts.sh${NC}"
      else
      echo -e "${RED}Detected alerts error, this may be that there are no alerts for $package, or if there was a syntax error${NC}"
      fi
       
      if [[ $dependserror = 0 ]]
      then
        echo -e "${GREEN}No errors in dependencies${NC}"
      else
        echo -e "${RED}Detected dependency error, if you try to launch $package and it works, you can ignore this error, but you may not get all the features of $package. If not, contact $package maintainer${NC}"
      fi
      
      if [[ $installerror = 0 ]]
      then
        echo -e "${GREEN}No errors in install.sh${NC}"
      else
        echo -e "${RED}Detected installing error, if you try to launch $package and it works, you can ignore this error. If not, contact $package maintainer${NC}"
      fi
      echo "Indexing..."
      echo "$package" >> /var/log/pacstall_installed
      exit 0
      else
      echo "$package does not exist in the $repo repository. Check your spelling or choose a different repository with ${RED}sudo pacstall -C${NC}"
      exit 1
      fi
      ;;
    -S|--search)
     search=$2
     repo=$(cat /usr/share/pacstall/repo/pacstallrepo.txt)
     wget -q --spider https://github.com/"$repo"/pacstall/tree/master/packages/$search/
     if [ $? -eq 0 ]; then
        read -p "${GREEN}$search${NC} is available in the ${PURPLE}$repo${NC} repository. Do you want to view the readme?" answer
	if [[ $answer = y ]] ; then
	pandoc -t plain https://raw.githubusercontent.com/$repo/pacstall/master/packages/$search/README.md | less
	exit 0
	else
	exit 0
        fi
     else
        echo "$search is not available. Add another repo or check your spelling"
	exit 1
     fi
      ;;
    -R|--remove)
      package=$2
      sudo rm $(cat /var/lib/porg/$package | sed -n 's/|\(.*\)//;/^#\(.*\)/d;p')
      if [ $? -eq 0 ]; then
        echo "Removed $package"
	echo "Indexing..."
	sed -i "/\b\($package\)\b/d" /var/log/pacstall_installed
	if [ $? -eq 0 ]; then
	  echo "Index successful"
	  exit 0
	else
	  echo "Index failed"
	  exit 1
	fi
	exit 0
      else
        echo "Failed to remove $package"
	exit 1
      fi
      ;;
    -C|--change-repo)
      echo "repo changer"
      cmd=(dialog --separate-output --checklist "Select Repository:" 22 76 16)
      options=(1 "Henryws" on    # any option can be set to default to "on"
               2 "Option 2" off
               3 "Option 3" off
               4 "Option 4" off)
      choices=$("${cmd[@]}" "${options[@]}" 2>&1 >/dev/tty)
      clear
      for choice in $choices
      do
          case $choice in
              1)
                  echo -e "${PURPLE}Henryws${NC} repository selected" && echo Henryws > /usr/share/pacstall/repo/pacstallrepo.txt
                  exit
                  ;;
              2)
                  echo "Second Option"
                  ;;
              3)
                  echo "Third Option"
                  ;;
              4)
                  echo "Fourth Option"
                  ;;
          esac
      done
      ;;
    -V|--version)
      COLOR='\e[0;34m'
      NC='\033[0m' # No Color
      echo -e "version 1.0.3 ${COLOR}Brandeis${NC}"
      exit 0
      ;;
    -U|--update)
      sudo wget -q https://raw.githubusercontent.com/Henryws/pacstall/master/pacstall -O /bin/pacstall
      echo "Updating complete"
      echo "You are at version $(pacstall -V)"
      exit 0
      ;;
    -L|--list)
      wc -l /var/log/pacstall_installed
      cat /var/log/pacstall_installed
      exit 0
      ;;
    -DL|--download-local)
      cd /var/cache/pacstall/
      package=$2
      repo=$(cat /usr/share/pacstall/repo/pacstallrepo.txt)
      if wget -q --show-progress:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$package/$package.tar.xz ; then
      sudo tar -xf $package.tar.xz
      cd $package
      wget -O- https://raw.githubusercontent.com/$repo/pacstall/master/packages/$package/install.sh
      cd ..
      tar cfJ $package.tar.xz $package
      if [[ $? -eq 0 ]] ; then
      exit 0
      else
      exit 1
      fi
      else 
      wget -q --show-progress --progress=bar:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$package/$package.zip
      unzip $package.zip
      cd $package
      wget -O- https://raw.githubusercontent.com/$repo/pacstall/master/packages/$package/install.sh
      cd ..
      tar cfJ $package.tar.xz $package
      if [[ $? -eq 0 ]] ; then
      exit 0
      else
      exit 1
      fi
      fi
      ;;
    -IL|--install-local)
      package=$2
      tar xf $package.tar.xz
      cd $package
      sudo ./install.sh
      if [[ $? -eq 0 ]] ; then
      exit 0
      else
      echo "Failed to install $package"
      exit 1
      fi
      ;;
     -Depcheck)
      $2=dep
      if [[ $(command -v apt) = /usr/bin/apt ]] ; then
        dpkg -s $dep
        if [[ $? -eq 0 ]] ; then
            echo "$dep exists... skipping"
        else
            sudo pacstall -Depinstall $dep
        fi
      else
          rpm -q $dep
          if [[ $? -eq 0 ]] ; then
              echo "$dep exists... skipping"
            else
                sudo pacstall -Depinstall $dep
            fi
      fi
      ;;
     -Depinstall)
      repo=$(cat /usr/share/pacstall/repo/pacstallrepo.txt)
      cd /tmp/pacstall
      if wget -q --show-progress --progress=bar:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$dep/$dep.tar.xz ; then
          echo "tar.xz detected"
          echo -e "${RED}extracting...${NC}"
          sudo tar -xf $dep.tar.xz
      else
          echo "tar.xz not detected... trying zip"
          wget -q --show-progress --progress=bar:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$dep/$dep.zip
          echo -e "${RED}extracting...${NC}"
          sudo unzip /tmp/pacstall/$dep.zip
      fi
      cd $dep*
      wget -q https://raw.githubusercontent.com/$repo/pacstall/master/packages/$dep/install.sh | bash
      echo "done installing $dep"
      ;;
     *)
      break
      ;;
  esac
done 
