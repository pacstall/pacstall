#!/bin/bash
while test $# -gt 0; do
  case "$1" in
    -h|--help)
      echo "$package - attempt to capture frames"
      echo " "
      echo "$package [options] application [arguments]"
      echo " "
      echo "options:"
      echo "-I, Installs package"
      echo "-S, Search for package"
      echo "-R, Removes package"
      echo "-C,	Chooses repo"
      echo "-U,	Update script"
      echo "-V, Prints version number"
      echo "-L, Lists installed packages"
      exit 0
      ;;
    -I)
      package=$2
      repo=$(cat /usr/share/pacstall/repo/pacstallrepo.txt)
      RED='\033[0;31m'
      CYAN='\033[0;36m'
      NC='\033[0m' # No Color
      GREEN='\033[0;32m'
      PURPLE='\033[0;35m'
      YELLOW='\033[1.33m'
      if [ ! -d /tmp/pacstall ]; then
	  mkdir -p /tmp/pacstall;
      fi
      #This is the part where it searches your package on all repos and puts it in /tmp
      echo -e "cleaning ${YELLOW}/tmp/pacstall${NC}"
      sudo rm -rf /tmp/pacstall
      sudo mkdir /tmp/pacstall
      cd /tmp/pacstall/
      echo "cleaning package folder"
      sudo rm -rf $package
      # This is where pacstall will alert the user of anything they might need to know that could affect the installation of there package
      wget -O- https://raw.githubusercontent.com/$repo/pacstall/master/packages/$package/alerts.sh | bash
      wget -O- https://raw.githubusercontent.com/$repo/pacstall/master/packages/$package/depends.sh | bash
      
      if wget -q --show-progress --progress=bar:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$package/$package.tar.xz ; then
          echo "tar.xz detected"
          echo -e "${RED}extracting...${NC}"
          sudo tar -xf $package.tar.xz
      else
          echo "tar.xz not detected... trying zip"
          wget -q --show-progress --progress=bar:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$package/$package.zip
          echo -e "${RED}extracting...${NC}"
          sudo unzip /tmp/pacstall/$package.zip
      fi
      cd $package
      echo -e "${CYAN}Downloading and running install script for ${GREEN}$package...${NC}"
      wget -O- https://raw.githubusercontent.com/$repo/pacstall/master/packages/$package/install.sh | bash
      echo "Cleaning up..."
      cd /tmp/pacstall
      rm -rf $package*
      echo "Indexing..."
      echo $package >> /etc/pacstall_packages
      sudo sed -i '$!N; /^\(.*\)\n\1$/!P; D' /etc/pacstall_packages
      exit 1
      ;;
    -S)
     repo=Henryws
     read -p "what package do you want to search for?" search
     wget -q --spider https://github.com/$repo/pacstall/tree/master/packages/$search/
     if [ $? -eq 0 ]; then
        read -p ""$search" is available in the "$repo" repository. Do you want to see the readme?" answer
	if [[ $answer = y ]] ; then
	pandoc -t plain https://raw.githubusercontent.com/$repo/pacstall/master/packages/$search/README.md | less
        fi
     else
        echo $search is not available. Add another repo or check your spelling
     fi
      ;;
    -R)
      echo "what package should be removed?"
      read $package
      sudo dpkg -r $package
      if [ $? -eq 0 ]; then
          echo "$package has been succesfuly removed"
      else
          echo "$package could not be removed"
      fi
      ;;
    -C)
      echo "repo changer"
      cmd=(dialog --separate-output --checklist "Select Repository:" 22 76 16)
      options=(1 "Henryws" on    # any option can be set to default to "on"
               2 "Option 2" off
               3 "Option 3" off
               4 "Option 4" off)
      choices=$("${cmd[@]}" "${options[@]}" 2>&1 >/dev/tty)
      clear
      for choice in $choices
      do
          case $choice in
              1)
                  echo "Henryws repository selected" && echo Henryws > /usr/share/pacstall/repo/pacstallrepo.txt
                  exit
                  ;;
              2)
                  echo "Second Option"
                  ;;
              3)
                  echo "Third Option"
                  ;;
              4)
                  echo "Fourth Option"
                  ;;
          esac
      done
      ;;
    -V)
      echo "version 0.2.4"
      break
      ;;    
    -U)
      sudo wget -q https://raw.githubusercontent.com/Henryws/pacstall/master/pacstall -O /bin/pacstall
      echo "Updating complete"
      exit 0
      ;;
    -L)
      wc -l /etc/pacstall_packages
      cat /etc/pacstall_packages
      exit 0
      ;;
     *)
      break
      ;;
  esac
done
