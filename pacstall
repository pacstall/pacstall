#!/bin/bash
while test $# -gt 0; do
  case "$1" in
    -h|--help)
      echo " "
      echo "options:"
      echo "-I --install, Installs package"
      echo "-S --search, Search for package"
      echo "-R --remove, Removes package"
      echo "-C --change-repo, Chooses repo"
      echo "-U --update, Update script"
      echo "-V --version, Prints version number"
      echo "-L --list, Lists installed packages"
      echo "-D --download, Downloads but doesn't install"
      echo "-SD --save-download, Downloads to directory inputed"
      echo "-CD --clear-downloads, Clears the package download folder"
      echo " "
      exit 0
      ;;
    -I|--install) 
      curl https://raw.githubusercontent.com/Henryws/pacstall/master/website-images/pacstallascii.txt
      package=$2
      repo=$(cat /usr/share/pacstall/repo/pacstallrepo.txt)
      RED='\033[0;31m'
      CYAN='\033[0;36m'
      NC='\033[0m' # No Color
      GREEN='\033[0;32m'
      PURPLE='\033[0;35m'
      YELLOW='\033[1;33m'
      BLUE='\033[0;34m'
      if [ ! -d /tmp/pacstall ]; then
	  mkdir -p /tmp/pacstall;
      fi
      #This is the part where it searches your package on all repos and puts it in /tmp
      echo -e "cleaning ${YELLOW}/tmp/pacstall${NC}"
      sudo rm -rf /tmp/pacstall
      sudo mkdir /tmp/pacstall
      cd /tmp/pacstall/
      echo "cleaning $package build directory"
      sudo rm -rf $package
      # This is where pacstall will alert the user of anything they might need to know that could affect the installation of there package
      url="$echo https://raw.githubusercontent.com/$repo/pacstall/master/packages/$package/install.sh"
      if wget $url >/dev/null 2>&1 ; then
          wget -O- https://raw.githubusercontent.com/$repo/pacstall/master/packages/$package/alerts.sh | bash
      
          alertserror=$?
      
          wget -O- https://raw.githubusercontent.com/$repo/pacstall/master/packages/$package/depends.sh | bash
      
          dependserror=$?
          
          #Finds package size and prompts for installation
	  if wget -q --show-progress --progress=bar:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$package/$package.tar.xz ; then
              pkgsize=$(curl -s https://github.com/$repo/pacstall/raw/master/packages/$package/$package.tar.xz | wc -c)
	      echo "$package will take up $pkgsize" && echo " "
	      echo "Do you want to continue?"
	      read confirm
	      if [[ $confirm = y ]]; then
	        break
	      else
	        exit 0
	      fi
          else
            pkgsize=$(curl -s https://github.com/$repo/pacstall/raw/master/packages/$package/$package.zip | wc -c)
	    echo "$package will take up $pkgsize" && echo " "
	      echo "Do you want to continue?"
	      read confirm
	      if [[ $confirm = y ]]; then
	        break
	      else
	        exit 0
	      fi
          else
	  fi	  
	 
          if wget -q --show-progress --progress=bar:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$package/$package.tar.xz ; then
              echo "tar.xz detected"
              echo -e "${RED}extracting...${NC}"
              sudo tar -xf $package.tar.xz
          else
              echo "tar.xz not detected... trying zip"
              wget -q --show-progress --progress=bar:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$package/$package.zip
              echo -e "${RED}extracting...${NC}"
              sudo unzip /tmp/pacstall/$package.zip
          fi
          cd $package
          echo -e "${CYAN}Downloading and running install script for ${GREEN}$package...${NC}"
          wget -O- https://raw.githubusercontent.com/$repo/pacstall/master/packages/$package/install.sh | bash
       
          installerror=$?
       
          echo -e "${GREEN}Cleaning up...${NC}"
          cd /tmp/pacstall
          rm -rf $package*
          echo " "
          echo "Checking for Errors..."
          if [[ $alertserror = 0 ]]
          then
            echo -e "${GREEN}No errors in alerts.sh${NC}"
          else
	    echo -e "${RED}Error with alerts.sh, this may be that there is no alerts.sh file, or if there was a syntax error${NC}"
          fi
       
          if [[ $dependserror = 0 ]]
          then
            echo -e "${GREEN}No errors in depends.sh${NC}"
          else
            echo -e "${RED}Error with depends.sh, if you try to launch $package and it works, you can ignore this error. If not, contact $package maintainer${NC}"
          fi
      
          if [[ $installerror = 0 ]]
          then
            echo -e "${GREEN}No errors in install.sh${NC}"
          else
            echo -e "${RED}Error in install.sh, if you try to launch $package and it works, you can ignore this error. If not, contact $package maintainer${NC}"
	  fi
	  echo "Indexing..."
	  echo $package >> /var/log/pacstall_installed
          exit 0
       else
          echo "$package does not exist in the $repo repository. Check your spelling or choose a different repo"
	  exit 1
       fi
      ;;
    -S|--search)
     search=$2
     repo=$(cat /usr/share/pacstall/repo/pacstallrepo.txt)
     wget -q --spider https://github.com/$repo/pacstall/tree/master/packages/$search/
     if [ $? -eq 0 ]; then
        read -p "${GREEN}"$search"${NC} is available in the ${PURPLE}"$repo"${NC} repository. Do you want to see the readme?" answer
	if [[ $answer = y ]] ; then
	pandoc -t plain https://raw.githubusercontent.com/$repo/pacstall/master/packages/$search/README.md | less
	exit 0
	else
	exit 0
        fi
     else
        echo $search is not available. Add another repo or check your spelling
	exit 1
     fi
      ;;
    -R|--remove)
      package=$2
      sudo rm `cat /var/log/paco/$package | sed -n 's/|\(.*\)//;/^#\(.*\)/d;p'`
      if [ $? -eq 0 ]; then
        echo "Removed $package"
	echo "Indexing..."
	sed -i "/\b\($package\)\b/d" /var/log/pacstall_installed
	if [ $? -eq 0 ]; then
	  echo "Index successful"
	  exit 0
	else
	  echo "Index failed"
	  exit 1
	fi
	exit 0
      else
        echo "Failed to remove $package"
	exit 1
      fi
      ;;
    -C|--change-repo)
      echo "repo changer"
      cmd=(dialog --separate-output --checklist "Select Repository:" 22 76 16)
      options=(1 "Henryws" on    # any option can be set to default to "on"
               2 "Option 2" off
               3 "Option 3" off
               4 "Option 4" off)
      choices=$("${cmd[@]}" "${options[@]}" 2>&1 >/dev/tty)
      clear
      for choice in $choices
      do
          case $choice in
              1)
                  echo -e "${PURPLE}Henryws${NC} repository selected" && echo Henryws > /usr/share/pacstall/repo/pacstallrepo.txt
                  exit
                  ;;
              2)
                  echo "Second Option"
                  ;;
              3)
                  echo "Third Option"
                  ;;
              4)
                  echo "Fourth Option"
                  ;;
          esac
      done
      ;;
    -V|--version)
      COLOR='\e[0;34m'
      NC='\033[0m' # No Color
      echo -e "version 1.0.3 ${COLOR}Brandeis${NC}"
      exit 0
      ;;
    -U|--update)
      sudo wget -q https://raw.githubusercontent.com/Henryws/pacstall/master/pacstall -O /bin/pacstall
      echo "Updating complete"
      exit 0
      ;;
    -L|--list)
      wc -l /etc/pacstall_packages
      cat /etc/pacstall_packages
      exit 0
      ;;
     -D|--download)
       package=$2
       repo=$(cat /usr/share/pacstall/repo/pacstallrepo.txt)
       #Downloads but doesn't install
       if [ ! -d /var/cache/pacstall ]; then
	  mkdir -p /var/cache/pacstall;
       fi
       cd /usr/share/pacstall/cache
       if wget -q -P /var/cache/pacstall --show-progress --progress=bar:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$package/$package.tar.xz; then
          echo "tar.xz detected"
       else
          echo "tar.xz not detected... trying zip"
          wget -q -P /var/cache/pacstall --show-progress --progress=bar:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$package/$package.zip
       fi
       echo You should probably check out https://raw.githubusercontent/$repo/pacstall/$package/install.sh and https://raw.githubusercontent/$repo/pacstall/$package/depends.sh 
       echo -e "Saved $package to ${YELLOW}/var/cache/pacstall/${NC}"
       exit 0
       ;;
     -CD|--clear-downloads)
        cd /var/cache/pacstall
	count=$(ls | wc -l)
	yes | sudo rm -rf /var/cache/pacstall/*
	echo "$count downloads removed"
	exit 0
       ;;
     -SD|--save-download)
        package=$2
	path=$3
	repo=$(cat /usr/share/pacstall/repo/pacstallrepo.txt)
        if wget -q -P $path --show-progress --progress=bar:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$package/$package.tar.xz; then
          echo "tar.xz detected"
       else
          echo "tar.xz not detected... trying zip"
          wget -q -P $path --show-progress --progress=bar:force:noscroll https://github.com/$repo/pacstall/raw/master/packages/$package/$package.zip
       fi
       exit 0
       ;;
     *)
      break
      ;;
  esac
done 
